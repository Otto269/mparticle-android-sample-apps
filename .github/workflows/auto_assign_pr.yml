name: 'Auto Assign PR'

on:
  workflow_run:
    workflows: ["Pull Request Opened"]
    types:
      - completed

jobs:
    log-info:
        name: "Add reviewers to PR"
        runs-on: ubuntu-latest
        steps:
          - name: "echo variables"
            run: |
              echo \"${{ github.event.workflow_run.event }}\"
              echo \"${{ github.event.pull_request.types }}\"
              echo \"${{ github.actor }}\"

    add-reviewers:
        name: "Add reviewers to PR"
        if: >
          github.event.workflow_run.event == 'pull_request' &&
          github.actor != 'dependabot[bot]'
        env:
          GITHUB_TOKEN: ${{ secrets.MP_SEMANTIC_RELEASE_BOT }}
          GIT_AUTHOR_NAME: mparticle-automation
          GIT_AUTHOR_EMAIL: developers@mparticle.com
          GIT_COMMITTER_NAME: mparticle-automation
          GIT_COMMITTER_EMAIL: developers@mparticle.com
        runs-on: ubuntu-latest
        steps:
          - name: 'Print Event'
            run: |
              echo ${{ github.event.workflow_run.event }}
          - name: 'Download artifact'
            uses: actions/github-script@v3.1.0
            with:
              script: |
                var artifacts = await github.actions.listWorkflowRunArtifacts({
                   owner: context.repo.owner,
                   repo: context.repo.repo,
                   run_id: ${{ github.event.workflow_run.id }},
                });
                var matchArtifact = artifacts.data.artifacts.filter((artifact) => {
                  return artifact.name == "pr"
                })[0];
                var download = await github.actions.downloadArtifact({
                   owner: context.repo.owner,
                   repo: context.repo.repo,
                   artifact_id: matchArtifact.id,
                   archive_format: 'zip',
                });
                var fs = require('fs');
                fs.writeFileSync('${{github.workspace}}/pr.zip', Buffer.from(download.data));
          - run: unzip pr.zip
          - name: 'Find PR Title'
            id: find-pr
            uses: actions/github-script@v6
            with:
              github-token: ${{ secrets.GITHUB_TOKEN }}
              script: |
                var fs = require('fs');
                var titleString = String(fs.readFileSync('./NR'));
                return titleString
              result-encoding: string
          - name: "Log PR Title"
            run: |
              echo "${{ steps.find-pr.outputs.result }}"

          - name: "Check PR title"
            id: is-docs
            if: >
                startsWith(${{ steps.find-pr.outputs.result }}, 'docs:')
            run: |
                OUTPUT=true
                echo "::set-output name=isDocs::$OUTPUT"
          - name: "echo isDocs"
            run: |
                echo ${{ steps.is-docs.outputs.isDocs }}
          - name: "PR title is docs"
            if: ${{steps.is-docs.outputs.isDocs == 'true'}}
            uses: rowi1de/auto-assign-review-teams@v1.1.3
            with:
              repo-token: ${{ secrets.MP_SEMANTIC_RELEASE_BOT }}
              org: "mParticle" #only needed for pick-one-from-persons-or-team=true
              teams: "docs-triage" # only works for GitHub Organisation/Teams
              include-draft: false # Draft PRs will be skipped (default: false)
              skip-with-manual-reviewers: 0 # Skip this action, if the number of reviwers was already assigned (default: 0)
              pick-one-from-persons-or-team: false
          - name: "PR title is not docs"
            if: ${{ steps.is-docs.outputs.isDocs != 'true'}}
            uses: rowi1de/auto-assign-review-teams@v1.1.3
            with:
              repo-token: ${{ secrets.MP_SEMANTIC_RELEASE_BOT }}
              org: "mParticle" #only needed for pick-one-from-persons-or-team=true
              teams: "android-triage" # only works for GitHub Organisation/Teams
              include-draft: false # Draft PRs will be skipped (default: false)
              skip-with-manual-reviewers: 0 # Skip this action, if the number of reviwers was already assigned (default: 0)
              pick-one-from-persons-or-team: false

